<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GlassFinance</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/16112/16112513.png">
    <link id="manifest-placeholder" rel="manifest">

    <!-- 1. Dependencias React & Recharts (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    
    <!-- 2. Compilador Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 4. SCRIPT DE INICIALIZACIÓN DE FIREBASE (Módulo) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBfYN8ZAC-UvyGFECIo-JKEP5_SQJPBWg",
            authDomain: "finanzas-c0397.firebaseapp.com",
            projectId: "finanzas-c0397",
            storageBucket: "finanzas-c0397.firebasestorage.app",
            messagingSenderId: "915605749318",
            appId: "1:915605749318:web:5f60729bc0c3a04b43d447",
            measurementId: "G-74VQH9T5G6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.firebaseDB = db;
        window.firebaseAuth = auth;
        window.signInAnonymously = signInAnonymously;
        
        window.fb = {
            collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch, where, getDocs
        };
        
        window.dispatchEvent(new Event('firebase-modules-ready'));
    </script>

    <!-- 5. SCRIPT DE LA APLICACIÓN (React/Babel) -->
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer } = Recharts;

        const TRANSACTIONS_COL = "shared_transactions"; 
        const GROUPS_COL = "shared_groups";

        const manifest = {
            name: "GlassFinance",
            short_name: "GlassFi",
            start_url: window.location.href,
            display: "standalone",
            background_color: "#0f172a",
            theme_color: "#0f172a",
            icons: [{ src: "https://cdn-icons-png.flaticon.com/512/16112/16112513.png", sizes: "512x512", type: "image/png" }]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.querySelector('#manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));

        // --- ICONS ---
        const Icons = {
            Wallet: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>,
            TrendingDown: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,
            Calendar: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            CreditCard: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
            Plus: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            X: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            PieChart: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            Receipt: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1z"/><line x1="14" y1="8" x2="8" y2="8"/><line x1="16" y1="12" x2="8" y2="12"/><line x1="13" y1="16" x2="8" y2="16"/></svg>,
            Printer: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            ChevronRight: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            ChevronLeft: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            ShoppingBag: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
            Home: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Car: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M5 17h2"/><path d="M15 17h2"/></svg>,
            Coffee: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
            Zap: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Smartphone: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>,
            Gift: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>,
            Bot: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>,
            Edit3: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>,
            Check: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Image: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
            Link: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Pencil: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Trash2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Download: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            UploadCloud: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="16 16 12 12 8 16"/></svg>
        };

        const ICON_GALLERY = [
            { name: 'shopping', icon: <Icons.ShoppingBag /> },
            { name: 'food', icon: <Icons.Coffee /> },
            { name: 'transport', icon: <Icons.Car /> },
            { name: 'home', icon: <Icons.Home /> },
            { name: 'utilities', icon: <Icons.Zap /> },
            { name: 'tech', icon: <Icons.Smartphone /> },
            { name: 'gift', icon: <Icons.Gift /> },
            { name: 'other', icon: <Icons.PieChart /> },
        ];

        const COLOR_PALETTE = ['#ec4899', '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#6366f1', '#0f766e', '#be123c'];

        // --- COMPONENTS ---
        const GlassCard = ({ children, className = '', onClick, style }) => (
            <div 
                onClick={onClick} 
                className={`glass-panel rounded-2xl p-4 md:p-6 text-white relative overflow-hidden transition-all duration-300 ${className} ${onClick ? 'cursor-pointer active:scale-[0.99]' : ''}`}
                style={style}
            >
                {children}
            </div>
        );

        const GroupedList = ({ transactions, monthIndex, year, onSelect, groupMeta, onEditGroup }) => {
            const getAmount = (tx) => {
                const txDate = new Date(tx.date);
                if (tx.installments > 1) {
                    const startMonthIndex = txDate.getFullYear() * 12 + txDate.getMonth();
                    const targetMonthIndex = year * 12 + monthIndex;
                    if (targetMonthIndex >= startMonthIndex && targetMonthIndex < startMonthIndex + tx.installments) {
                        return tx.amount / tx.installments;
                    }
                    return 0;
                }
                if (tx.subtype === 'fixed') return tx.amount;
                if (txDate.getMonth() === monthIndex && txDate.getFullYear() === year) return tx.amount;
                return 0;
            };

            const getQuotaInfo = (tx) => {
                if (tx.installments <= 1) return null;
                const txDate = new Date(tx.date);
                const targetMonthIndex = year * 12 + monthIndex;
                const startMonthIndex = txDate.getFullYear() * 12 + txDate.getMonth();
                const current = targetMonthIndex - startMonthIndex + 1;
                return { current, total: tx.installments };
            };

            const groups = useMemo(() => {
                const grps = {};
                transactions.forEach(t => {
                    const amt = getAmount(t);
                    if (amt > 0) {
                        const gName = t.groupName || 'Varios';
                        const meta = groupMeta.find(g => g.name === gName); 
                        let color = meta ? meta.color : 'from-pink-500 to-purple-600';
                        if (!meta) {
                            const lower = gName.toLowerCase();
                            if (lower.includes('naranja')) color = 'from-orange-500 to-red-500';
                            else if (lower.includes('galicia')) color = 'from-amber-500 to-orange-400';
                            else if (lower.includes('icbc')) color = 'from-red-600 to-red-800';
                            else if (lower.includes('a pagar')) color = 'from-emerald-500 to-emerald-800';
                        }
                        
                        if (!grps[gName]) grps[gName] = { total: 0, items: [], color };
                        grps[gName].items.push({ ...t, currentAmt: amt, quotaInfo: getQuotaInfo(t) });
                        grps[gName].total += amt;
                    }
                });
                return grps;
            }, [transactions, monthIndex, year, groupMeta]);

            if (Object.keys(groups).length === 0) {
                return (
                    <div className="flex flex-col items-center justify-center py-10 text-white/40 gap-4">
                        <Icons.PieChart size={48} className="opacity-20" />
                        <p>No hay gastos para este periodo.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6 pb-20">
                    {Object.entries(groups).map(([groupName, data]) => (
                        <div key={groupName} className="animate-in">
                            <div className={`flex items-center justify-between mb-4 p-4 rounded-2xl bg-gradient-to-r ${data.color} shadow-lg relative overflow-hidden group/header`}>
                                <div className="absolute inset-0 bg-white/10 backdrop-blur-[2px]"></div>
                                <div className="relative flex items-center gap-3">
                                    <div className="p-2 bg-white/20 rounded-lg backdrop-blur-md shadow-sm">
                                        <Icons.CreditCard size={20} className="text-white"/> 
                                    </div>
                                    <div>
                                        <h3 className="text-white font-bold text-lg leading-tight uppercase tracking-wide flex items-center gap-2">
                                            {groupName}
                                            <button onClick={() => onEditGroup(groupName, data.color)} className="opacity-50 hover:opacity-100 transition p-1 bg-white/10 rounded-full"><Icons.Edit3 size={14}/></button>
                                        </h3>
                                        <p className="text-white/70 text-[10px] font-medium">TOTAL GRUPO</p>
                                    </div>
                                </div>
                                <div className="relative text-right">
                                    <span className="text-xl font-bold text-white text-shadow-sm">${data.total.toLocaleString('es-AR')}</span>
                                </div>
                            </div>

                            <div className="grid gap-3">
                                {data.items.map(tx => (
                                    <div 
                                        key={tx.id} 
                                        onClick={() => onSelect(tx)}
                                        className="glass-panel rounded-xl p-3 md:p-4 flex items-center gap-4 transition-all duration-300 group cursor-pointer relative overflow-hidden hover:scale-[1.01]"
                                        style={{ 
                                            background: `linear-gradient(90deg, rgba(255,255,255,0.05) 0%, ${tx.color}22 100%)` 
                                        }}
                                    >
                                        {/* Hover Overlay Gradient */}
                                        <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300" 
                                             style={{ background: `linear-gradient(45deg, transparent, ${tx.color}40)` }}></div>

                                        <div className="absolute left-0 top-0 bottom-0 w-1" style={{ backgroundColor: tx.color }}></div>
                                        <div className="relative w-10 h-10 md:w-12 md:h-12 rounded-full bg-slate-900/50 flex-shrink-0 flex items-center justify-center border border-white/10 overflow-hidden">
                                            {tx.image ? (
                                                <img src={tx.image} className="w-full h-full object-cover" />
                                            ) : (
                                                <div style={{ color: tx.color }}>{ICON_GALLERY.find(i => i.name === tx.icon)?.icon}</div>
                                            )}
                                        </div>
                                        <div className="flex-1 min-w-0 relative">
                                            <div className="flex justify-between items-start">
                                                <h4 className="text-white font-medium truncate pr-2 text-sm md:text-base">{tx.description}</h4>
                                                <span className="text-white font-bold text-sm md:text-base whitespace-nowrap">${tx.currentAmt.toLocaleString('es-AR')}</span>
                                            </div>
                                            <div className="flex justify-between items-center mt-1">
                                                <p className="text-white/40 text-xs flex items-center gap-1">{tx.category}</p>
                                                {tx.quotaInfo && (
                                                    <div className="flex items-center gap-2 bg-black/30 px-2 py-0.5 rounded-md border border-white/5">
                                                        <div className="w-12 h-1 bg-white/10 rounded-full overflow-hidden">
                                                            <div className="h-full rounded-full" style={{ width: `${(tx.quotaInfo.current/tx.quotaInfo.total)*100}%`, backgroundColor: tx.color }}></div>
                                                        </div>
                                                        <span className="text-[10px] font-mono font-bold text-white/80">{tx.quotaInfo.current}/{tx.quotaInfo.total}</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        <div className="text-white/20 group-hover:text-white/60 transition-colors relative">
                                           <Icons.Pencil size={14} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- DATA SEEDER ---
        const seedData = (db) => {
            const batch = window.fb.writeBatch(db);
            const { doc } = window.fb;
            
            const getDate = (currentQuota) => {
                const dec2025 = new Date(2025, 11, 1);
                dec2025.setMonth(dec2025.getMonth() - (currentQuota - 1));
                return dec2025.toISOString().split('T')[0];
            };

            const add = (desc, amount, group, quotaC=1, quotaT=1, cat='Varios', color='#ec4899') => {
                const id = Math.random().toString(36).substr(2, 9);
                const ref = doc(db, TRANSACTIONS_COL, id);
                batch.set(ref, {
                    type: 'expense',
                    subtype: quotaT > 1 ? 'credit' : 'fixed',
                    amount: amount * quotaT,
                    description: desc,
                    category: cat,
                    groupName: group,
                    date: getDate(quotaC),
                    installments: quotaT,
                    icon: 'shopping',
                    color: color
                });
            };

            // A PAGAR
            const grp1 = "A PAGAR";
            add('EPEC', 85000, grp1, 1, 1, 'Servicios', '#06b6d4');
            add('Aguas Cordobesas', 45000, grp1, 1, 1, 'Servicios', '#3b82f6');
            add('Nobis', 100000, grp1, 1, 3, 'Salud', '#10b981'); 
            add('Gas', 12000, grp1, 1, 1, 'Servicios', '#f59e0b');
            add('Google', 45000, grp1, 1, 1, 'Suscripciones', '#ef4444');
            add('NETFLIX', 18000, grp1, 1, 1, 'Suscripciones', '#ef4444');
            add('Flow', 65000, grp1, 1, 1, 'Servicios', '#8b5cf6');
            add('Mercado Pago', 50000, grp1, 3, 12, 'Varios', '#3b82f6');
            add('All Boys', 30000, grp1, 1, 1, 'Deportes', '#ffffff');
            add('Préstamo Gobierno', 15000, grp1, 1, 1, 'Deudas', '#6366f1');
            add('Monotributo', 20000, grp1, 1, 1, 'Impuestos', '#f59e0b');
            add('Auto', 450000, grp1, 8, 42, 'Vehículo', '#ec4899');
            add('Seguro', 60000, grp1, 3, 4, 'Seguros', '#10b981');
            add('MeLi', 4000, grp1, 1, 1, 'Compras', '#f59e0b');

            // NARANJA
            const grp2 = "NARANJA";
            add('MANTENIMIENTO', 8000, grp2, 1, 1, 'Bancario', '#f59e0b');
            add('HELADERA', 69286, grp2, 7, 14, 'Hogar', '#ef4444');
            add('CELULAR', 38600, grp2, 7, 12, 'Tecnología', '#8b5cf6');
            add('CARTERA', 5833, grp2, 5, 6, 'Ropa', '#ec4899');
            add('IMPUESTOS', 3000, grp2, 1, 1, 'Impuestos', '#10b981');
            add('ZAPATILLAS MA', 26667, grp2, 5, 6, 'Ropa', '#ec4899');
            add('ROPA SPORTS', 34000, grp2, 1, 1, 'Ropa', '#ec4899');
            add('PASTILLAS', 15000, grp2, 3, 3, 'Salud', '#06b6d4');
            add('RESPUESTO PA', 59333, grp2, 2, 3, 'Vehículo', '#6366f1');
            add('CASA', 33333, grp2, 1, 3, 'Hogar', '#f59e0b');
            add('KANGOO', 216000, grp2, 1, 3, 'Vehículo', '#ec4899');
            add('ROPA KARMYA', 66667, grp2, 2, 3, 'Ropa', '#ec4899');
            add('GORRA Y +', 30000, grp2, 1, 6, 'Ropa', '#ec4899');
            add('BATERIA', 28333, grp2, 2, 6, 'Vehículo', '#3b82f6');

            // GALICIA
            const grp3 = "TARJETA GALICIA";
            add('MERCADO LIBRE', 4000, grp3, 11, 12, 'Compras', '#f59e0b');
            add('PC', 40000, grp3, 8, 12, 'Tecnología', '#8b5cf6');
            add('JOYSTICK', 6000, grp3, 8, 12, 'Tecnología', '#8b5cf6');
            add('CAFÉ', 5000, grp3, 8, 12, 'Comida', '#10b981');
            add('FUENTE', 12000, grp3, 8, 9, 'Tecnología', '#8b5cf6');
            add('CAFES Y BT', 3200, grp3, 7, 12, 'Varios', '#10b981');
            add('TALLERES', 160000, grp3, 1, 1, 'Vehículo', '#3b82f6');
            add('KARMIA', 18333, grp3, 6, 6, 'Ropa', '#ec4899');
            add('ROPA INVIERNO', 60000, grp3, 5, 6, 'Ropa', '#ec4899');
            add('CAMPERA CUERO', 25000, grp3, 5, 6, 'Ropa', '#ec4899');
            add('ZAPATOS', 19000, grp3, 5, 6, 'Ropa', '#ec4899');
            add('STITCH', 36000, grp3, 5, 6, 'Varios', '#f59e0b');
            add('CELULARES', 40000, grp3, 5, 12, 'Tecnología', '#8b5cf6');
            add('IMP SELLOS', 3000, grp3, 1, 1, 'Impuestos', '#10b981');
            add('MANDOLINA', 17000, grp3, 4, 6, 'Hogar', '#f59e0b');
            add('TINTA', 6000, grp3, 4, 6, 'Oficina', '#06b6d4');
            add('LAVARROPAS', 77500, grp3, 4, 6, 'Hogar', '#f59e0b');
            add('JUEGOS', 20000, grp3, 1, 1, 'Ocio', '#8b5cf6');
            add('ROPA CARO', 16667, grp3, 1, 3, 'Ropa', '#ec4899');
            add('ROPA LUCAS', 36667, grp3, 1, 6, 'Ropa', '#ec4899');
            add('ML HIGIEN', 12000, grp3, 1, 12, 'Salud', '#10b981');

            // ICBC
            const grp4 = "ICBC";
            add('LIFE SEGUROS', 6400, grp4, 1, 1, 'Seguros', '#10b981');
            add('AIRE ACOND', 105000, grp4, 9, 12, 'Hogar', '#3b82f6');
            add('ROMANO HNOS', 3000, grp4, 9, 12, 'Varios', '#f59e0b');
            add('IMPUESTOS', 5000, grp4, 1, 1, 'Impuestos', '#10b981');
            add('LIFE SEGURO', 7000, grp4, 1, 1, 'Seguros', '#10b981');
            add('IVA', 4000, grp4, 1, 1, 'Impuestos', '#10b981');
            add('COMISIÓN', 3500, grp4, 1, 1, 'Bancario', '#f59e0b');
            add('CELULARES', 160000, grp4, 4, 12, 'Tecnología', '#8b5cf6');
            add('CARGADOR IP', 11833, grp4, 2, 6, 'Tecnología', '#8b5cf6');
            add('SEGURO', 1700, grp4, 1, 1, 'Seguros', '#10b981');

            return batch.commit();
        };

        // --- MAIN APP ---
        const App = () => {
            const [currentDate] = useState(new Date(2025, 11, 1)); 
            const [transactions, setTransactions] = useState([]);
            const [groupMeta, setGroupMeta] = useState([]); 
            const [view, setView] = useState('dashboard');
            const [selectedFutureMonth, setSelectedFutureMonth] = useState(null);
            
            const [showModal, setShowModal] = useState(false);
            const [showGroupModal, setShowGroupModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [groupEditData, setGroupEditData] = useState({ oldName: '', newName: '', color: '' });

            const [formData, setFormData] = useState({
                type: 'expense', subtype: 'one-time', amount: '', description: '', category: '', 
                groupName: 'A PAGAR', installments: 1, image: '', imageUrl: '', icon: 'shopping', color: '#ec4899'
            });

            const [dbReady, setDbReady] = useState(false);
            const [isLoadingSeed, setIsLoadingSeed] = useState(false);

            useEffect(() => {
                const initDb = () => {
                    const { collection, query, orderBy, onSnapshot, doc } = window.fb;
                    const db = window.firebaseDB;
                    const auth = window.firebaseAuth;
                    const signIn = window.signInAnonymously;

                    if (db && auth && signIn) {
                        signIn(auth)
                            .then(() => {
                                setDbReady(true);
                                const q = query(collection(db, TRANSACTIONS_COL), orderBy("date", "desc"));
                                onSnapshot(q, (snapshot) => {
                                    const txs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    setTransactions(txs);
                                });
                                onSnapshot(collection(db, GROUPS_COL), (snapshot) => {
                                    const metas = snapshot.docs.map(doc => doc.data());
                                    setGroupMeta(metas);
                                });
                            })
                            .catch(e => {
                                console.error(e);
                                alert("Error conexión: " + e.message);
                            });
                    }
                };
                if (window.firebaseDB) initDb();
                else window.addEventListener('firebase-modules-ready', initDb);
                return () => window.removeEventListener('firebase-modules-ready', initDb);
            }, []);

            const handleInstall = async () => {
                // ... (previous logic)
            };

            const loadInitialData = async () => {
                if(!dbReady) return;
                setIsLoadingSeed(true);
                try {
                    await seedData(window.firebaseDB);
                } catch(e) {
                    console.error(e);
                    alert("Error al importar datos. Revisa permisos.");
                }
                setIsLoadingSeed(false);
            };

            const dashboardTotals = useMemo(() => {
                const m = currentDate.getMonth();
                const y = currentDate.getFullYear();
                let expense = 0;
                transactions.filter(t => t.type === 'expense').forEach(t => {
                    const txDate = new Date(t.date);
                    let val = 0;
                    if (t.installments > 1) {
                        const start = txDate.getFullYear() * 12 + txDate.getMonth();
                        const target = y * 12 + m;
                        if (target >= start && target < start + t.installments) val = t.amount / t.installments;
                    } else if (t.subtype === 'fixed' || (txDate.getMonth() === m && txDate.getFullYear() === y)) val = t.amount;
                    expense += val;
                });
                return expense;
            }, [transactions, currentDate]);

            const futureData = useMemo(() => {
                const data = [];
                for(let i=0; i<6; i++) {
                    const d = new Date(currentDate);
                    d.setMonth(d.getMonth() + i);
                    const m = d.getMonth();
                    const y = d.getFullYear();
                    let total = 0, tarjetas = 0;
                    transactions.forEach(t => {
                        if(t.type === 'expense') {
                            const txDate = new Date(t.date);
                            let val = 0;
                            if (t.installments > 1) {
                                const start = txDate.getFullYear() * 12 + txDate.getMonth();
                                const target = y * 12 + m;
                                if (target >= start && target < start + t.installments) val = t.amount / t.installments;
                            } else if (t.subtype === 'fixed' || (txDate.getMonth() === m && txDate.getFullYear() === y)) val = t.amount;
                            if (val > 0) {
                                total += val;
                                if (t.installments > 1 || t.groupName.toLowerCase().includes('tarjeta')) tarjetas += val;
                            }
                        }
                    });
                    data.push({ name: d.toLocaleString('es-ES', { month: 'short' }).toUpperCase(), total, tarjetas, index: m, year: y });
                }
                return data;
            }, [transactions, currentDate]);

            const openAdd = () => {
                setEditingId(null);
                setFormData({ type: 'expense', subtype: 'one-time', amount: '', description: '', category: '', groupName: 'A PAGAR', installments: 1, image: '', imageUrl: '', icon: 'shopping', color: '#ec4899', date: new Date().toISOString().split('T')[0] });
                setShowModal(true);
            };

            const openEdit = (tx) => {
                setEditingId(tx.id);
                setFormData({ ...tx, amount: tx.amount, imageUrl: '' });
                setShowModal(true);
            };

            const saveTx = async () => {
                if (!formData.description || !formData.amount) return;
                if (!dbReady) {
                    alert("Base de datos no conectada. Espera un momento.");
                    return;
                }
                try {
                    const finalImg = formData.imageUrl || formData.image;
                    const txData = { ...formData, amount: Number(formData.amount), image: finalImg, date: editingId ? formData.date : new Date().toISOString().split('T')[0] };
                    const { collection, addDoc, updateDoc, doc } = window.fb;
                    
                    if (editingId) await updateDoc(doc(window.firebaseDB, TRANSACTIONS_COL, editingId), txData);
                    else await addDoc(collection(window.firebaseDB, TRANSACTIONS_COL), txData);
                    
                    setShowModal(false);
                } catch(e) {
                    console.error(e);
                    alert("Error al guardar: " + e.message);
                }
            };

            const deleteTx = async () => {
                if (confirm('¿Eliminar gasto?') && dbReady) {
                    const { deleteDoc, doc } = window.fb;
                    await deleteDoc(doc(window.firebaseDB, TRANSACTIONS_COL, editingId));
                    setShowModal(false);
                }
            };

            const openGroupEdit = (name, currentColor) => {
                setGroupEditData({ oldName: name, newName: name, color: currentColor });
                setShowGroupModal(true);
            };

            const saveGroupEdit = async () => {
                if (!dbReady) return;
                const { oldName, newName, color } = groupEditData;
                const batch = window.fb.writeBatch(window.firebaseDB);
                batch.set(window.fb.doc(window.firebaseDB, GROUPS_COL, newName), { name: newName, color });
                if (oldName !== newName) {
                    batch.delete(window.fb.doc(window.firebaseDB, GROUPS_COL, oldName));
                    const snap = await window.fb.getDocs(window.fb.query(window.fb.collection(window.firebaseDB, TRANSACTIONS_COL), window.fb.where("groupName", "==", oldName)));
                    snap.forEach(d => batch.update(d.ref, { groupName: newName }));
                }
                await batch.commit();
                setShowGroupModal(false);
            };

            const handleFile = (e) => {
                const f = e.target.files[0];
                if (f) {
                    const r = new FileReader();
                    r.onload = () => setFormData(p => ({ ...p, image: r.result }));
                    r.readAsDataURL(f);
                }
            };

            if (!dbReady) return <div className="min-h-screen bg-[#0f172a] flex items-center justify-center text-white animate-pulse">Conectando...</div>;

            return (
                <div className="max-w-4xl mx-auto p-4 md:p-6 pb-24">
                    <header className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3">
                            <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-2.5 rounded-xl border border-white/10 shadow-xl"><Icons.Wallet className="text-pink-400" size={24} /></div>
                            <div><h1 className="text-2xl font-bold text-white tracking-tight">GlassFinance</h1><p className="text-pink-400 text-xs font-mono font-bold uppercase tracking-widest">{currentDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</p></div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={handleInstall} className="bg-white/10 hover:bg-white/20 text-white p-3 rounded-full transition-all"><Icons.Download size={20} /></button>
                            <button onClick={openAdd} className="bg-pink-600 hover:bg-pink-500 text-white p-3 rounded-full shadow-lg shadow-pink-500/30 transition-all"><Icons.Plus size={24} /></button>
                        </div>
                    </header>

                    <div className="hidden md:flex gap-4 mb-6">
                        <button onClick={() => { setView('dashboard'); setSelectedFutureMonth(null); }} className={`px-6 py-2 rounded-full font-bold transition-all ${view === 'dashboard' ? 'bg-white text-black' : 'text-white/50 hover:bg-white/10'}`}>Resumen</button>
                        <button onClick={() => setView('future')} className={`px-6 py-2 rounded-full font-bold transition-all ${view === 'future' ? 'bg-white text-black' : 'text-white/50 hover:bg-white/10'}`}>Futuro</button>
                    </div>

                    <main>
                        {view === 'dashboard' && (
                            <div className="animate-in space-y-6">
                                <GlassCard className="bg-gradient-to-r from-slate-800 to-slate-900 border-white/5">
                                    <div className="flex justify-between items-start">
                                        <div><p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Total a Pagar</p><h2 className="text-4xl md:text-5xl font-bold text-white tracking-tighter">${dashboardTotals.toLocaleString('es-AR')}</h2></div>
                                        <div className="p-3 bg-white/5 rounded-full"><Icons.TrendingDown className="text-rose-400" /></div>
                                    </div>
                                </GlassCard>
                                
                                {transactions.length === 0 ? (
                                    <div className="text-center py-10">
                                        <p className="text-white/50 mb-4">No hay gastos registrados aún.</p>
                                        <button onClick={loadInitialData} disabled={isLoadingSeed} className="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 mx-auto disabled:opacity-50">
                                            {isLoadingSeed ? 'Cargando...' : <><Icons.UploadCloud size={20}/> Importar Gastos Predeterminados</>}
                                        </button>
                                    </div>
                                ) : (
                                    <GroupedList transactions={transactions} monthIndex={currentDate.getMonth()} year={currentDate.getFullYear()} onSelect={openEdit} groupMeta={groupMeta} onEditGroup={openGroupEdit} />
                                )}
                            </div>
                        )}
                        {/* ... Rest of future view and modals remains similar but connected to new data functions ... */}
                        {view === 'future' && (
                            <div className="animate-in space-y-6">
                                {!selectedFutureMonth ? (
                                    <>
                                        <GlassCard className="h-64">
                                            <h3 className="font-bold text-white mb-4">Proyección Semestral</h3>
                                            <ResponsiveContainer width="100%" height="100%">
                                                <AreaChart data={futureData} margin={{top:5, right:0, left:-20, bottom:0}}>
                                                    <defs><linearGradient id="colorTotal" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#ec4899" stopOpacity={0.6}/><stop offset="95%" stopColor="#ec4899" stopOpacity={0}/></linearGradient></defs>
                                                    <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" vertical={false} />
                                                    <XAxis dataKey="name" stroke="rgba(255,255,255,0.3)" tick={{fill:'white', fontSize:10}} axisLine={false} tickLine={false} />
                                                    <YAxis stroke="rgba(255,255,255,0.3)" tick={{fill:'white', fontSize:10}} axisLine={false} tickLine={false} tickFormatter={v=>`${(v/1000).toFixed(0)}k`} />
                                                    <RechartsTooltip contentStyle={{backgroundColor:'#1e293b', border:'none', borderRadius:'8px'}} itemStyle={{color:'#fff'}} formatter={v=>`$${v.toLocaleString('es-AR')}`} />
                                                    <Area type="monotone" dataKey="total" stroke="#ec4899" strokeWidth={3} fill="url(#colorTotal)" />
                                                </AreaChart>
                                            </ResponsiveContainer>
                                        </GlassCard>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            {futureData.map(m => (
                                                <GlassCard key={m.name} onClick={() => setSelectedFutureMonth({index: m.index, year: m.year})} className="hover:border-pink-500/50 group">
                                                    <div className="flex justify-between items-center mb-2"><span className="font-bold text-lg group-hover:text-pink-400 transition-colors">{m.name}</span><Icons.ChevronRight size={16} className="text-white/30" /></div>
                                                    <div className="text-2xl font-bold tracking-tighter">${m.total.toLocaleString('es-AR')}</div>
                                                </GlassCard>
                                            ))}
                                        </div>
                                    </>
                                ) : (
                                    <div className="animate-in">
                                        <button onClick={() => setSelectedFutureMonth(null)} className="flex items-center gap-2 text-pink-400 font-bold mb-4 hover:text-white transition-colors"><Icons.ChevronLeft size={20} /> Volver a Proyección</button>
                                        <GroupedList transactions={transactions} monthIndex={selectedFutureMonth.index} year={selectedFutureMonth.year} onSelect={openEdit} groupMeta={groupMeta} onEditGroup={openGroupEdit} />
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    <div className="md:hidden fixed bottom-0 left-0 right-0 h-20 bg-[#0f172a]/90 backdrop-blur-xl border-t border-white/10 flex justify-around items-center px-4 z-40 pb-2">
                        <button onClick={() => { setView('dashboard'); setSelectedFutureMonth(null); }} className={`flex flex-col items-center gap-1 ${view === 'dashboard' ? 'text-pink-500' : 'text-slate-500'}`}><Icons.PieChart size={24} /> <span className="text-[10px] font-bold">Hoy</span></button>
                        <button onClick={openAdd} className="bg-pink-600 rounded-full w-14 h-14 flex items-center justify-center -mt-8 border-4 border-[#0f172a] shadow-lg shadow-pink-600/40"><Icons.Plus size={28} className="text-white" /></button>
                        <button onClick={() => setView('future')} className={`flex flex-col items-center gap-1 ${view === 'future' ? 'text-pink-500' : 'text-slate-500'}`}><Icons.Calendar size={24} /> <span className="text-[10px] font-bold">Futuro</span></button>
                    </div>

                    {showModal && (
                        <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/80 backdrop-blur-sm">
                            <div className="bg-[#1e293b] w-full md:max-w-lg md:rounded-3xl rounded-t-3xl border-t border-white/20 h-[85vh] md:h-auto flex flex-col overflow-hidden animate-in">
                                <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                                    <h3 className="font-bold text-white flex items-center gap-2"><Icons.Edit3 size={18} className="text-pink-400"/> {editingId ? 'Editar' : 'Nuevo'}</h3>
                                    <button onClick={() => setShowModal(false)}><Icons.X className="text-white/50 hover:text-white"/></button>
                                </div>
                                <div className="p-6 overflow-y-auto flex-1 space-y-5">
                                    <div className="text-center py-2"><label className="text-xs text-white/40 uppercase font-bold">Monto Total</label><input type="number" placeholder="0" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} className="bg-transparent text-5xl font-bold text-center text-white w-full focus:outline-none placeholder:text-white/10" autoFocus /></div>
                                    <div className="space-y-3">
                                        <div><label className="text-xs text-pink-400 font-bold uppercase ml-1">Descripción</label><input type="text" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} className="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-white focus:border-pink-500 outline-none" placeholder="Ej: Supermercado" /></div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-xs text-pink-400 font-bold uppercase ml-1">Grupo / Tarjeta</label>
                                                <input list="groups" type="text" value={formData.groupName} onChange={e => setFormData({...formData, groupName: e.target.value})} className="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-white focus:border-pink-500 outline-none" placeholder="A PAGAR" />
                                                <datalist id="groups"><option value="A PAGAR" /><option value="NARANJA" /><option value="TARJETA GALICIA" /><option value="ICBC" /></datalist>
                                            </div>
                                            <div><label className="text-xs text-pink-400 font-bold uppercase ml-1">Cuotas</label><select value={formData.installments} onChange={e => setFormData({...formData, installments: Number(e.target.value)})} className="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-white outline-none">{[1,3,6,9,12,18,24,30,42].map(n => <option key={n} value={n}>{n} cuotas</option>)}</select></div>
                                        </div>
                                    </div>
                                    {/* COLOR PICKER IN ADD MODAL */}
                                    <div className="bg-white/5 p-4 rounded-xl border border-white/10 space-y-3">
                                        <label className="text-xs text-white/50 uppercase font-bold">Color del Gasto</label>
                                        <div className="flex gap-2 overflow-x-auto pb-2">
                                            {COLOR_PALETTE.map(c => (
                                                <button 
                                                    key={c} 
                                                    onClick={() => setFormData({...formData, color: c})} 
                                                    className={`w-8 h-8 rounded-full border-2 transition-transform ${formData.color === c ? 'border-white scale-110' : 'border-transparent opacity-50 hover:opacity-100'}`}
                                                    style={{ backgroundColor: c }}
                                                />
                                            ))}
                                        </div>
                                    </div>

                                    <div className="bg-white/5 p-4 rounded-xl border border-white/10 space-y-3">
                                        <div className="flex gap-2 text-xs font-bold text-white/50 uppercase"><span>Imagen o Icono</span></div>
                                        <div className="flex items-center gap-2 bg-black/30 rounded-lg p-2 border border-white/5"><Icons.Link size={16} className="text-white/40"/><input type="text" placeholder="https://..." value={formData.imageUrl} onChange={e => setFormData({...formData, imageUrl: e.target.value, image: ''})} className="bg-transparent text-sm w-full text-white outline-none" /></div>
                                        <div className="grid grid-cols-4 gap-2">
                                            <label className="aspect-square bg-white/5 border-dashed border border-white/20 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-white/10"><Icons.Image size={18} className="text-white/40 mb-1"/><span className="text-[8px] uppercase font-bold text-white/40">Subir</span><input type="file" className="hidden" onChange={handleFile} accept="image/*"/></label>
                                            {/* Icon Selector */}
                                            {ICON_GALLERY.slice(0,3).map(icon => (
                                                <button key={icon.name} onClick={() => setFormData({...formData, icon: icon.name, image: '', imageUrl: ''})} className={`aspect-square rounded-lg flex items-center justify-center ${formData.icon === icon.name && !formData.image ? 'bg-pink-600' : 'bg-white/5 hover:bg-white/10'}`}>
                                                    {icon.icon}
                                                </button>
                                            ))}
                                            {(formData.image || formData.imageUrl) && (<div className="col-span-1 aspect-square rounded-lg overflow-hidden border border-pink-500 relative"><img src={formData.imageUrl || formData.image} className="w-full h-full object-cover" /><button onClick={() => setFormData({...formData, image:'', imageUrl:''})} className="absolute inset-0 bg-black/50 opacity-0 hover:opacity-100 flex items-center justify-center"><Icons.X size={16} className="text-white"/></button></div>)}
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 bg-black/40 flex gap-3">
                                    {editingId && <button onClick={deleteTx} className="p-4 bg-red-500/20 text-red-400 rounded-xl"><Icons.Trash2 /></button>}
                                    <button onClick={saveTx} className="flex-1 bg-gradient-to-r from-pink-600 to-purple-600 text-white font-bold rounded-xl py-4 shadow-lg active:scale-[0.98]">Guardar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showGroupModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm px-4">
                            <div className="bg-[#1e293b] w-full max-w-sm rounded-2xl border border-white/20 p-6 animate-in">
                                <h3 className="text-lg font-bold text-white mb-4">Editar Grupo</h3>
                                <label className="text-xs text-white/50 uppercase font-bold">Nombre del Grupo</label>
                                <input type="text" value={groupEditData.newName} onChange={e => setGroupEditData({...groupEditData, newName: e.target.value})} className="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-white focus:border-pink-500 outline-none mb-4" />
                                <label className="text-xs text-white/50 uppercase font-bold mb-2 block">Color de Etiqueta</label>
                                <div className="grid grid-cols-4 gap-2 mb-6">
                                    {['from-pink-500 to-purple-600', 'from-orange-500 to-red-500', 'from-amber-500 to-orange-400', 'from-red-600 to-red-800', 'from-emerald-500 to-emerald-800', 'from-blue-600 to-blue-800', 'from-cyan-500 to-blue-500', 'from-slate-700 to-slate-900'].map(c => (
                                        <button key={c} onClick={() => setGroupEditData({...groupEditData, color: c})} className={`h-10 rounded-lg bg-gradient-to-r ${c} ${groupEditData.color === c ? 'ring-2 ring-white scale-105' : 'opacity-70 hover:opacity-100'}`}></button>
                                    ))}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowGroupModal(false)} className="flex-1 py-3 bg-white/10 text-white rounded-xl">Cancelar</button>
                                    <button onClick={saveGroupEdit} className="flex-1 py-3 bg-pink-600 text-white font-bold rounded-xl">Guardar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
